<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/gh/frankeno/xsalert@main/src/xsalert.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/frankeno/xsalert@main/src/themes/light-theme.css">

    <script src="https://cdn.jsdelivr.net/gh/frankeno/xsalert@main/src/xsalert.js"></script>
    <!-- navbar.css -->
    <link rel="stylesheet" type="text/css" href="/css/navbar.css">
    <!-- invoice.css -->
    <link rel="stylesheet" type="text/css" href="/css/invoice.css">
    <script src="/js/invoice.js"></script>
    <title>Invoice Creator</title>

    <script>

    let rowCount = 0;

    function addRow(){
        const table = document.getElementById("invoice-item-table");
        const row = table.insertRow(-1);
        const numberCell = row.insertCell(0);
        const quantityCell = row.insertCell(1);
        const costCell = row.insertCell(2);
        const descriptionCell = row.insertCell(3);

        numberCell.innerHTML = `${++rowCount}`;
        quantityCell.innerHTML = `<input style="width:150px" type="number" name="quantity">`;
        costCell.innerHTML = `<input style="width=10px" type="number" name="cost">`;
        descriptionCell.innerHTML = `<input style="width=10px" type="text" name="description">`;
    }

        function pushInvoiceToQuickbooks(invoice_id) {
            console.log('push invoice to quickbooks clicked');

            $.ajax({
                url: '/pushInvoiceToQuickbooks',
                method: 'POST',
                contentType: 'application/json', // Set content type
                data: JSON.stringify({
                    invoice_id: invoice_id,
                    takeoff_id: document.getElementById('takeoff_id').value,
                }),
                success: function (response) {
                    XSAlert({
                        title: 'Success',
                        message: 'Invoice pushed to Quickbooks',
                        icon: 'success',
                    });
                },
                error: function (error) {
                    XSAlert({
                        title: 'Error',
                        message: 'Failed to push invoice to Quickbooks.',
                        icon: 'error',
                        hideCancelButton: true
                    }).then((result) => {

                        console.log('clicked');
                        window.location.href = '/quickbooks';
                    });
                    //window.location.href = '/quickbooks';
                },
            });
        }

        function shareInvoiceWithCustomer(invoiceId) {
            console.log('share with customer clicked');

            const takeoffId = document.getElementById('takeoff_id').value;

            if (!invoiceId || !takeoffId) {
                XSAlert.alert('Invoice ID or Takeoff ID not defined');
                return;
            }

            $.ajax({
                url: '/share-invoice',
                method: 'POST',
                contentType: 'application/json', // Set content type
                data: JSON.stringify({
                    invoice_id: invoiceId,
                    takeoff_id: takeoffId,
                }),
                success: function (response) {
                    XSAlert({
                        title: 'Success',
                        message: 'Email sent to customer',
                        icon: 'success',
                    });
                },
                error: function (error) {
                    XSAlert({
                        title: 'Error',
                        message: 'Failed to send email to customer.',
                        icon: 'error',
                    });
                },
            });

        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('form');

            // hide the invoce initially
            document.querySelector('.invoice-container').style.display = 'none';


            form.addEventListener('submit', function (event) {
                event.preventDefault();

                const customerName = document.getElementById('customer-name').value;
                const email = document.getElementById('email').value;
                const takeoffId = document.getElementById('takeoff_id').value;

                if (!customerName || !email) {
                    XSAlert.alert('Please fill out all required fields');
                    return;
                }



                if (!takeoffId) {
                    XSAlert.alert('Takeoff ID not defined');
                    return;
                }

                const invoiceItems = [];
                const rows = document.querySelectorAll("#invoice-item-table tbody tr");

                rows.forEach(row => {
                    const quantity = row.querySelector("input[name='quantity']").value;
                    const cost = row.querySelector("input[name='cost']").value;
                    const description = row.querySelector("input[name='description']").value;

                    if (quantity && cost && description) {
                        invoiceItems.push({
                            quantity: quantity,
                            cost: cost,
                            description: description
                        });
                    }
                });

                $.ajax({
                    url: '/create-invoice',
                    method: 'POST',
                    contentType: 'application/json', // Set content type
                    data: JSON.stringify({
                        customer_name: customerName,
                        email: email,
                        takeoff_id: takeoffId,
                        invoice_items: invoiceItems
                    }),
                    success: function (invoice) {
                        const invoiceContainer = document.querySelector('.invoice-container');

                        // show the invoice
                        invoiceContainer.style.display = 'inline-block';

                        // hide the form-container
                        document.querySelector('.form-container').style.display = 'none';

                        console.log("invoice", invoice);

                        // append the invoice_number to the invoice-info
                        const invoiceInfo = document.querySelector('.invoice-info');

                        // created_at: "2025-01-07T01:22:16.000Z"
                        // hash: null
                        // id: 26
                        // invoice_number: "1-26"
                        // timeline: [{date: "2025-01-07T01:22:16.000Z", label: "Invoice Created", amount: "200.00"}] (1)
                        // total: "200.00"
                        // view_count: 0
                        const invoiceHtml = `
                    <p>Invoice Number: ${invoice.invoice_number}</p>
                    <p>Total: ${invoice.total}</p>
                    <p>Created At: ${moment(invoice.created_at).format('MMMM Do YYYY, h:mm:ss a')}</p>
                    <h3>Timeline:</h3>
                    <ul>
                        ${invoice.timeline.map(event => `
                            <li>${moment(event.date).format('MMMM Do YYYY, h:mm:ss a')} - ${event.label}: ${event.amount}</li>
                        `).join('')}
                    </ul>
                    <div style="display:flex; gap: 15px;">
                        <div id="shareWithCustomer">
                            <button id="share-with-customer" onclick="shareInvoiceWithCustomer(${invoice.id});">Share with Customer</button>
                        </div>
                        {{^invoice.qb_number}}
                        <div id="pushToQuickbooks">
                            <button id="push-to-quickbooks" onclick="pushInvoiceToQuickbooks(${invoice.id});">Push to Quickbooks</button>
                        </div>
                        {{/invoice.qb_number}}
                    </div>
                `;
                        invoiceInfo.innerHTML = invoiceHtml;


                    },
                    error: function (error) {
                        XSAlert.alert('Failed to create invoice. Please try again.');
                    },
                });


            });

        });

    </script>
</head>

<body>

    <!-- navbar here -->
    <div class="navbar">
        <ul>
            <li><a href="javascript:history.back()">Back</a></li>
            <li><a href="/">{{defaults.sysName}}</a></li>
            <div style="float:right">
                <li><a href="/auth/google">Log In</a></li>
                <li><a href="/logout">Log Out</a></li>
            </div>


        </ul>
    </div>
    <div class="form-container">
        <form action="/createInvoice" method="POST">
            {{#takeoff}}


            <input type="input" id="hidden-input" name="invoice_name" value="{{invoice_name}}">

            <input type="hidden" id="takeoff_id" name="takeoff_id" value="{{takeoff_id}}">
            <label for="customer-name">Customer Name</label>
            <input type="text" id="customer-name" name="customer_name" value="{{customer_givenName}}" required>

            <label for="email">Invoice Email</label>
            <input type="email" id="email" name="invoice_email" value="{{takeoff.customer_invoice_email_address}}"
                required>
            <!-- 
            <label for="invoice-date">Invoice Date</label>
            <input type="date" id="invoice-date" name="invoice_date" value="2024-11-26" required>

            <label for="time">Time</label>
            <input type="time" id="time" name="time" value="13:00"> -->

            <!-- <label for="payment-amount">Payment Amount</label>
            <input type="text" id="custom-amount" name="custom_amount" placeholder="Enter custom amount" min="0"> -->

            <!-- a table with columns number, quantity, cost, description -->
            <table id="invoice-item-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Quantity</th>
                        <th>Cost</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="invoice-items">
                  
                </tbody>
            </table>

            <!-- add row button -->
             <button type="button" onclick="addRow()">Add Row</button>

            <button type="submit">Create Invoice</button>
            {{/takeoff}}
        </form>
    </div>
    <div class="invoice-container">
        <h1>Invoice</h1>

        <div class="invoice-info">



        </div>
</body>

</html>